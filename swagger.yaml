openapi: 3.0.0
info:
  title: CMA Portal Backend API
  description: RESTful API for CMA Portal with JWT Authentication and Google OAuth
  version: 1.0.0
  contact:
    name: API Support
    email: support@cma-portal.com

servers:
  - url: http://localhost:5000
    description: Development server
  - url: https://api.cma-portal.com
    description: Production server

tags:
  - name: Authentication
    description: User authentication and token management
  - name: Users
    description: User management operations (protected)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    CookieAuth:
      type: apiKey
      in: cookie
      name: jwt

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        fullname:
          type: string
          example: "John Doe"
        username:
          type: string
          example: "johndoe"
        status:
          type: string
          example: "active"
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00.000Z"

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: "johndoe"
        password:
          type: string
          format: password
          example: "SecurePass123"

    LoginResponse:
      type: object
      properties:
        msg:
          type: string
          example: "Logged in"
        token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    CreateUserRequest:
      type: object
      required:
        - username
        - password
        - status
      properties:
        username:
          type: string
          example: "johndoe"
        password:
          type: string
          format: password
          example: "SecurePass123"
        status:
          type: string
          example: "active"

    CreateUserResponse:
      type: object
      properties:
        msg:
          type: string
          example: "OK"
        message:
          type: string
          example: "New user johndoe created"
        token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    UpdateUserRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: "johndoe"
        password:
          type: string
          format: password
          example: "NewSecurePass123"

    UsersResponse:
      type: object
      properties:
        msg:
          type: string
          example: "OK"
        data:
          type: array
          items:
            $ref: '#/components/schemas/User'

    UserResponse:
      type: object
      properties:
        msg:
          type: string
          example: "OK"
        data:
          type: array
          items:
            $ref: '#/components/schemas/User'

    Error:
      type: object
      properties:
        message:
          type: string
          example: "Error message"
        error:
          type: string
          example: "Detailed error information"

paths:
  /api/users/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user with username and password. Returns JWT token and sets refresh token in HTTP-only cookie.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Successfully logged in
          headers:
            Set-Cookie:
              schema:
                type: string
                example: jwt=refresh_token; HttpOnly; Secure; SameSite=None; Max-Age=777600
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                type: string
                example: "Invalid Username or Password"
        '429':
          description: Too many login attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/refresh-token:
    get:
      tags:
        - Authentication
      summary: Refresh access token
      description: Get a new JWT access token using the refresh token stored in HTTP-only cookie
      security:
        - CookieAuth: []
      responses:
        '200':
          description: New access token generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Unauthorized - No refresh token found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - Invalid refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: Create a new user account. Returns JWT token upon successful registration.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateUserResponse'
        '401':
          description: Username already taken
          content:
            application/json:
              schema:
                type: string
                example: "Oops! Username already taken!"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/allUsers:
    get:
      tags:
        - Users
      summary: Get all users
      description: Retrieve a list of all registered users (protected route)
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of users retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsersResponse'
        '401':
          description: Unauthorized - No token provided
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - Invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/userById/{id}:
    get:
      tags:
        - Users
      summary: Get user by ID
      description: Retrieve a specific user by their UUID (protected route)
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: User UUID
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: User retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  msg:
                    type: string
                    example: "not found"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/updateUser/{id}:
    put:
      tags:
        - Users
      summary: Update user
      description: Update user information by UUID (protected route)
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: User UUID
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  msg:
                    type: string
                    example: "OK"
                  data:
                    $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  msg:
                    type: string
                    example: "Not Found"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/deleteUser/{id}:
    delete:
      tags:
        - Users
      summary: Delete user
      description: Delete a user by UUID (protected route)
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: User UUID
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  msg:
                    type: string
                    example: "OK"
                  data:
                    $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  msg:
                    type: string
                    example: "Not Found"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'